{% extends "base.html" %}
{% if atleta %}
    {% set page_title = "Editar atleta" %}
{% else %}
    {% set page_title = "Novo atleta" %}
{% endif %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ page_title }}</h1>
        <p class="page-subtitle">Cadastre ou atualize os dados do atleta.</p>
    </div>
    <a href="{{ url_for('atletas.listar') }}" class="btn btn-outline">Voltar</a>
</div>

<div class="card">
    <div class="card-body">
        <form method="post" class="form-grid">

            <!-- Dados básicos -->
            <div class="form-group">
                <label for="nome">Nome completo *</label>
                <input type="text" id="nome" name="nome" class="form-control"
                       value="{{ atleta.nome if atleta }}" required>
            </div>

            <div class="form-group">
                <label for="data_nascimento">Data de nascimento *</label>
                <input type="date" id="data_nascimento" name="data_nascimento" class="form-control"
                       value="{{ atleta.data_nascimento if atleta }}" required>
            </div>

            <div class="form-group">
                <label for="posicao">Posição</label>
                <input type="text" id="posicao" name="posicao" class="form-control"
                       placeholder="Goleiro, zagueiro, meia..."
                       value="{{ atleta.posicao if atleta }}">
            </div>

            {% if atleta %}
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status" class="form-control">
                    <option value="ATIVO" {% if atleta.status == 'ATIVO' %}selected{% endif %}>Ativo</option>
                    <option value="INATIVO" {% if atleta.status == 'INATIVO' %}selected{% endif %}>Inativo</option>
                </select>
            </div>
            {% endif %}

            <!-- Documento: RG / CPF -->
            <div class="form-group">
                <label>Documento</label>
                <select id="tipo_doc" class="form-control">
                    <option value="">Selecione...</option>
                    <option value="RG">RG</option>
                    <option value="CPF">CPF</option>
                </select>
            </div>

            <div class="form-group">
                <label for="rg">RG</label>
                <input type="text" id="rg" name="rg" class="form-control"
                       value="{{ atleta.rg if atleta }}" disabled>
            </div>

            <div class="form-group">
                <label for="cpf">CPF</label>
                <input type="text" id="cpf" name="cpf" class="form-control"
                       value="{{ atleta.cpf if atleta }}" disabled>
            </div>

            <!-- Endereço -->
            <div class="form-group">
                <label for="cep">CEP</label>
                <input type="text" id="cep" name="cep" class="form-control"
                       placeholder="00000-000"
                       value="{{ atleta.cep if atleta }}">
            </div>

            <div class="form-group">
                <label for="logradouro">Endereço</label>
                <input type="text" id="logradouro" name="logradouro" class="form-control"
                       value="{{ atleta.logradouro if atleta }}">
            </div>

            <div class="form-group">
                <label for="numero">Número</label>
                <input type="text" id="numero" name="numero" class="form-control"
                       value="{{ atleta.numero if atleta }}">
            </div>

            <div class="form-group">
                <label for="complemento">Complemento</label>
                <input type="text" id="complemento" name="complemento" class="form-control"
                       value="{{ atleta.complemento if atleta }}">
            </div>

            <div class="form-group">
                <label for="bairro">Bairro</label>
                <input type="text" id="bairro" name="bairro" class="form-control"
                       value="{{ atleta.bairro if atleta }}">
            </div>

            <div class="form-group">
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" name="cidade" class="form-control"
                       value="{{ atleta.cidade if atleta }}">
            </div>

            <div class="form-group">
                <label for="estado">UF</label>
                <input type="text" id="estado" name="estado" class="form-control"
                       maxlength="2"
                       value="{{ atleta.estado if atleta }}">
            </div>

            <!-- Documentos -->
            <div class="form-group">
                <label>Documentos entregues</label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="doc_rg_ok"
                           {% if atleta and atleta.doc_rg_ok %}checked{% endif %}>
                    RG
                </label><br>
                <label class="checkbox-inline">
                    <input type="checkbox" name="doc_cpf_ok"
                           {% if atleta and atleta.doc_cpf_ok %}checked{% endif %}>
                    CPF
                </label><br>
                <label class="checkbox-inline">
                    <input type="checkbox" name="doc_comprov_endereco_ok"
                           {% if atleta and atleta.doc_comprov_endereco_ok %}checked{% endif %}>
                    Comprovante de endereço
                </label><br>
                <label class="checkbox-inline">
                    <input type="checkbox" name="doc_decl_escolar_ok"
                           {% if atleta and atleta.doc_decl_escolar_ok %}checked{% endif %}>
                    Declaração escolar
                </label><br>
                <label class="checkbox-inline">
                    <input type="checkbox" name="doc_atestado_medico_ok"
                           {% if atleta and atleta.doc_atestado_medico_ok %}checked{% endif %}>
                    Atestado médico
                </label>
            </div>

            <div class="form-group">
                <label for="validade_atestado">Validade do atestado médico</label>
                <input type="date" id="validade_atestado" name="validade_atestado"
                       class="form-control"
                       value="{{ atleta.validade_atestado if atleta }}">
            </div>

            <!-- Responsável -->
            <div class="form-group form-group-full">
                <hr>
                <strong>Responsável</strong>
            </div>

            <div class="form-group">
                <label for="responsavel_nome">Nome do responsável</label>
                <input type="text" id="responsavel_nome" name="responsavel_nome" class="form-control"
                       value="{{ atleta.responsavel_nome if atleta }}">
            </div>

            <div class="form-group">
                <label for="responsavel_cpf">CPF do responsável</label>
                <input type="text" id="responsavel_cpf" name="responsavel_cpf" class="form-control"
                       value="{{ atleta.responsavel_cpf if atleta }}">
            </div>

            <div class="form-group">
                <label for="responsavel_telefone">Telefone do responsável</label>
                <input type="text" id="responsavel_telefone" name="responsavel_telefone" class="form-control"
                       value="{{ atleta.responsavel_telefone if atleta }}">
            </div>

            <!-- Plano -->
            <div class="form-group form-group-full">
                <hr>
                <strong>Plano e grupos</strong>
            </div>

            <div class="form-group">
                <label for="plano_id">Plano</label>
                <select id="plano_id" name="plano_id" class="form-control">
                    <option value="">Nenhum</option>
                    {% for p in planos %}
                        {% set selected = false %}
                        {% if plano_id_atual is defined and plano_id_atual == p.id %}
                            {% set selected = true %}
                        {% endif %}
                        <option value="{{ p.id }}"
                            {% if selected %}selected{% endif %}>
                            {{ p.nome }} — R$ {{ '%.2f'|format(p.valor_mensal) }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group form-group-full">
                <label>Grupos do atleta</label>
                {% for g in grupos %}
                    <label class="checkbox-inline">
                        <input type="checkbox" name="grupos_ids"
                               value="{{ g.id }}"
                               {% if grupos_ids_atuais is defined and g.id in grupos_ids_atuais %}checked{% endif %}>
                        {{ g.nome }}
                    </label><br>
                {% else %}
                    <p class="empty-state">Nenhum grupo cadastrado ainda.</p>
                {% endfor %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    {% if atleta %}Salvar alterações{% else %}Cadastrar atleta{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Habilita campo RG ou CPF conforme seleção
    const tipoDoc = document.getElementById('tipo_doc');
    const rgInput = document.getElementById('rg');
    const cpfInput = document.getElementById('cpf');

    function atualizarDoc() {
        if (!tipoDoc) return;
        const v = tipoDoc.value;
        if (v === 'RG') {
            rgInput.disabled = false;
            cpfInput.disabled = true;
        } else if (v === 'CPF') {
            rgInput.disabled = true;
            cpfInput.disabled = false;
        } else {
            rgInput.disabled = true;
            cpfInput.disabled = true;
        }
    }

    if (tipoDoc) {
        tipoDoc.addEventListener('change', atualizarDoc);
        atualizarDoc();
    }

    // Busca CEP na API ViaCEP
    const cepInput = document.getElementById('cep');
    if (cepInput) {
        cepInput.addEventListener('blur', function () {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length !== 8) return;

            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(r => r.json())
                .then(data => {
                    if (data.erro) return;
                    document.getElementById('logradouro').value = data.logradouro || '';
                    document.getElementById('bairro').value = data.bairro || '';
                    document.getElementById('cidade').value = data.localidade || '';
                    document.getElementById('estado').value = data.uf || '';
                })
                .catch(e => console.error(e));
        });
    }
</script>
{% endblock %}
