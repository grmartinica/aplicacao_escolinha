{% extends "base.html" %}
{% block title %}Financeiro | Admin{% endblock %}
{% block content %}
<h2>Financeiro (Admin)</h2>

<div class="kpis">
  <div class="kpi">
      <div class="t">Total pago</div>
      <div class="v">R$ {{ '%.2f'|format(total_pago) }}</div>
  </div>
  <div class="kpi">
      <div class="t">Total pendente</div>
      <div class="v">R$ {{ '%.2f'|format(total_pendente) }}</div>
  </div>
  <div class="kpi">
      <div class="t">Inadimplências</div>
      <div class="v">{{ qtd_inad }}</div>
  </div>
</div>

<table class="table">
  <thead>
    <tr>
      <th>Atleta</th>
      <th>Descrição</th>
      <th>Vencimento</th>
      <th>Valor</th>
      <th>Status</th>
      <th>Cobrança</th>
    </tr>
  </thead>
  <tbody>
    {% for c in itens %}
      <tr>
        <td>{{ c.atleta.nome if c.atleta else '-' }}</td>
        <td>{{ c.descricao }}</td>
        <td>{{ c.vencimento }}</td>
        <td>R$ {{ '%.2f'|format(c.valor) }}</td>
        <td>{{ c.status }}</td>
        <td>
            {% if c.status != 'PAGO' and c.atleta and c.atleta.responsavel_telefone %}
                {% set tel = c.atleta.responsavel_telefone
                    |replace(' ','')
                    |replace('-','')
                    |replace('(','')
                    |replace(')','') %}
                {% set msg = (
                    'Olá! As mensalidades do atleta ' ~ (c.atleta.nome or '') ~
                    ' estão em aberto. Vencimento: ' ~ (c.vencimento|string) ~
                    ', valor R$ ' ~ ('%.2f'|format(c.valor)) ~
                    '. Por favor, entre em contato com a escolinha para regularizar. Muito obrigado!'
                ) %}
                <a class="btn btn-outline btn-sm"
                   target="_blank"
                   href="https://wa.me/{{ tel }}?text={{ msg|urlencode }}">
                    Cobrar no WhatsApp
                </a>
            {% else %}
                -
            {% endif %}
        </td>
      </tr>
    {% else %}
      <tr><td colspan="6">Sem registros.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
